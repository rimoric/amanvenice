<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMAN Venice - Room Dashboard</title>
    
    <!-- MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <!-- CSS from room-02.html (complete styles) -->
    <style>
        /* ===== VARIABILI CSS ===== */
        :root {
            --aman-green: #1a4a3a;
            --aman-gold: #d4af37;
            --wine-medium: #911e42;
            --wine-dark: #641428;
            --gray-light: #e6e6e6;
            --gray-medium: #999999;
            --white: #ffffff;
            --black: #000000;
            --blue: #0066ff;
            --green: #00ff00;
            --yellow: #ffff00;
            --orange: #ff9933;
            --red: #ff3333;
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .logo {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }

        .logo-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .logo-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        .login-title {
            color: var(--white);
            font-size: 28px;
            margin-bottom: 30px;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            backdrop-filter: blur(5px);
        }

        .password-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .password-input:focus {
            outline: none;
            border-color: var(--aman-gold);
            background: rgba(255, 255, 255, 0.3);
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, var(--aman-green), var(--aman-gold));
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .error-message {
            color: #ff6b6b;
            margin-top: 15px;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* ===== LOADING SCREEN ===== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .loading-container {
            text-align: center;
            color: var(--white);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 300;
            opacity: 0.9;
        }

        .loading-details {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== MAIN APP ===== */
        .main-app {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .main-app.show {
            display: flex;
        }

        .header {
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .nav-container {
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            border-bottom: 2px solid var(--aman-gold);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 15px 25px;
            background: var(--aman-green);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: rgba(26, 74, 58, 0.8);
        }

        .nav-tab.active {
            background: var(--aman-gold);
            color: var(--aman-green);
            border-bottom-color: var(--wine-medium);
        }

        .content-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== ROOM HEADER ===== */
        .room-header {
            background: var(--aman-green);
            color: var(--aman-gold);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .room-title {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .room-subtitle {
            font-size: 16px;
            opacity: 0.8;
        }

        /* ===== CONTROLS GRID ===== */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-container {
            background: transparent;
            border-radius: 15px;
            padding: 0;
            box-shadow: none;
            transition: all 0.3s ease;
        }

        .control-container:hover {
            transform: none;
            box-shadow: none;
        }

        /* ===== DALI CONTROLS ===== */
        .dali-controller {
            background: linear-gradient(135deg, #EDD4B4 0%, #FAFAF0 100%);
            border: 1px solid rgba(139, 69, 19, 0.3);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            width: 100%;
        }

        .dali-controller:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .uniform-element {
            font-size: 1em;
            font-weight: 500;
            padding: 12px 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(139, 69, 19, 0.2);
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .group-label, .command-name {
            color: #8B4513;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
            font-weight: 600;
        }

        .main-controls {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            gap: 15px;
            margin: 20px 0;
            position: relative;
            z-index: 2;
        }

        .level-display {
            flex: 1;
        }

        .level-value {
            color: #5D4037;
            width: 100%;
            min-width: 80px;
        }

        .level-value.on {
            background: rgba(255, 193, 7, 0.4);
            color: #8B4513;
            border-color: rgba(255, 193, 7, 0.5);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.25);
        }

        .level-value.off {
            background: rgba(108, 117, 125, 0.3);
            color: #6C757D;
            border-color: rgba(108, 117, 125, 0.4);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.1);
        }

        .level-unit {
            font-size: 1em;
            opacity: 0.8;
        }

        .power-controls {
            display: flex;
            gap: 10px;
        }

        /* ===== PULSANTI DALI UNIFICATI ===== */
        .power-btn, .command-button, .monostable-button {
            color: #FFFFFF;
            cursor: pointer;
            min-width: 70px;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 600;
            border: none;
        }

        .power-btn:hover, .command-button:hover, .monostable-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .power-btn.active, .power-btn.on-active {
            background: #2E7D32;
            border-color: #1B5E20;
            color: #FFFFFF;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
        }

        .power-btn.active:hover {
            background: #388E3C;
            border-color: #2E7D32;
        }

        .command-button.active {
            background: #2E7D32;
            border-color: #1B5E20;
            color: #FFFFFF;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
        }

        .command-button.inactive {
            background: rgba(108, 117, 125, 0.3);
            border-color: rgba(108, 117, 125, 0.4);
            color: #6C757D;
        }

        .monostable-button.pressed {
            background: rgba(0, 102, 255, 0.35);
            border-color: rgba(0, 102, 255, 0.5);
            color: #66ccff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3);
            transform: scale(0.95);
        }

        .monostable-button.executed {
            background: #2E7D32;
            border-color: #1B5E20;
            color: #FFFFFF;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
        }

        .level-control {
            margin: 30px 0;
            position: relative;
            z-index: 2;
        }

        .level-label {
            font-size: 0.9em;
            color: #5D4037;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .level-slider-container {
            position: relative;
            padding: 10px 0;
        }

        .level-slider {
            width: 100%;
            height: 8px;
            background: rgba(139, 69, 19, 0.2);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(139, 69, 19, 0.1);
        }

        /* ===== SLIDER FILL UNIFICATO ===== */
        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, #2E7D32, #4CAF50);
            border-radius: 4px;
            transition: width 0.3s ease;
            position: relative;
        }

        .level-thumb {
            position: absolute;
            top: -8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            border: 2px solid rgba(139, 69, 19, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            user-select: none;
        }

        .level-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.3);
            border-color: rgba(139, 69, 19, 0.7);
        }

        .level-thumb.active {
            background: #4CAF50;
            border-color: #2E7D32;
        }

        .level-thumb.dragging {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
            border-color: rgba(139, 69, 19, 0.7);
            transition: none;
        }

        .slider-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.7em;
            color: rgba(93, 64, 55, 0.7);
            position: relative;
        }

        .slider-scale .min-indicator {
            position: absolute;
            left: 10%;
            top: -2px;
            font-size: 0.6em;
            color: #2E7D32;
            font-weight: bold;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            font-size: 0.85em;
            color: #5D4037;
            position: relative;
            z-index: 2;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.on, .status-dot.active {
            background: rgba(255, 193, 7, 0.8);
        }

        .status-dot.off, .status-dot.inactive {
            background: rgba(108, 117, 125, 0.8);
        }

        .status-dot.ready {
            background: rgba(139, 69, 19, 0.7);
            animation: pulse-slow 3s infinite;
        }

        .status-dot.executing {
            background: rgba(0, 102, 255, 0.8);
            animation: pulse-fast 0.5s infinite;
        }

        .status-dot.executed {
            background: rgba(40, 167, 69, 0.8);
            animation: pulse 2s infinite;
        }

        /* ===== ANIMAZIONI PULSE CONSOLIDATE ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        @keyframes pulse-fast {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.3); }
        }

        @keyframes pulse-climate {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .command-feedback {
            color: #5D4037;
            text-align: center;
            font-size: 0.9em;
            font-weight: 400;
        }

        .command-feedback.active {
            background: rgba(40, 167, 69, 0.25);
            border-color: rgba(40, 167, 69, 0.35);
            color: #28a745;
        }

        .command-feedback.inactive {
            background: rgba(108, 117, 125, 0.2);
            border-color: rgba(108, 117, 125, 0.3);
            color: #6C757D;
        }

        .command-feedback.ready {
            background: rgba(139, 69, 19, 0.1);
            border-color: rgba(139, 69, 19, 0.2);
            color: #8B4513;
        }

        .command-feedback.executing {
            background: rgba(0, 102, 255, 0.3);
            border-color: rgba(0, 102, 255, 0.4);
            color: #66ccff;
            animation: pulse 1s infinite;
        }

        .command-feedback.executed {
            background: rgba(40, 167, 69, 0.25);
            border-color: rgba(40, 167, 69, 0.35);
            color: #28a745;
        }

        .level-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(139, 69, 19, 0.2);
            color: #5D4037;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .level-btn:hover {
            background: rgba(139, 69, 19, 0.25);
            border-color: rgba(139, 69, 19, 0.4);
            transform: translateY(-2px) scale(1.05);
            color: #8B4513;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.2);
        }

        .level-btn:active {
            transform: translateY(0) scale(0.95);
        }

        /* Rimozione status indicator per DALI */
        .dali-controller .status-indicator {
            display: none;
        }

        /* Previeni la selezione del testo durante il drag */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* ===== COMMAND SWITCH & MONOSTABLE ===== */
        .command-switch, .monostable-switch {
            background: linear-gradient(135deg, #EDD4B4 0%, #FAFAF0 100%);
            border: 1px solid rgba(139, 69, 19, 0.3);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            width: 100%;
        }

        .command-switch:hover, .monostable-switch:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        /* ===== THERMOSTAT CONTROLS ===== */
        .temperature-display-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .level-value.setpoint {
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
        }

        .measured-temp-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px;
            border-radius: 15px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(139, 69, 19, 0.2);
        }

        .measured-temp-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: all 0.4s ease;
            border-radius: 15px;
        }

        .measured-temp-container.heating {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.4) 0%, rgba(255, 152, 0, 0.3) 100%);
            border-color: rgba(244, 67, 54, 0.6);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.25);
        }

        .measured-temp-container.heating::before {
            background: radial-gradient(circle at 30% 30%, rgba(255, 87, 34, 0.3) 0%, transparent 60%);
            opacity: 1;
        }

        .measured-temp-container.cooling {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.4) 0%, rgba(3, 169, 244, 0.3) 100%);
            border-color: rgba(33, 150, 243, 0.6);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.25);
        }

        .measured-temp-container.cooling::before {
            background: radial-gradient(circle at 70% 70%, rgba(129, 212, 250, 0.4) 0%, transparent 60%);
            opacity: 1;
        }

        .measured-temp-container.neutral {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.4) 0%, rgba(129, 199, 132, 0.3) 100%);
            border-color: rgba(76, 175, 80, 0.6);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.25);
        }

        .measured-temp-container.neutral::before {
            background: radial-gradient(circle at 50% 50%, rgba(165, 214, 167, 0.3) 0%, transparent 60%);
            opacity: 1;
        }

        .measured-temp-container.off {
            background: rgba(108, 117, 125, 0.3);
            border-color: rgba(108, 117, 125, 0.4);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.1);
        }

        .measured-temp-label {
            font-size: 0.8em;
            font-weight: 600;
            letter-spacing: 0.5px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            transition: color 0.3s ease;
            color: #5D4037;
        }

        .measured-temp-container.heating .measured-temp-label {
            color: #D32F2F;
        }

        .measured-temp-container.cooling .measured-temp-label {
            color: #1976D2;
        }

        .measured-temp-container.neutral .measured-temp-label {
            color: #388E3C;
        }

        .measured-temp-container.off .measured-temp-label {
            color: #6C757D;
        }

        .measured-temp-value {
            font-size: 1.1em;
            font-weight: 700;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            color: #5D4037;
        }

        .measured-temp-container.heating .measured-temp-value {
            color: #C62828;
        }

        .measured-temp-container.cooling .measured-temp-value {
            color: #1565C0;
        }

        .measured-temp-container.neutral .measured-temp-value {
            color: #2E7D32;
        }

        .measured-temp-container.off .measured-temp-value {
            color: #6C757D;
        }

        .measured-unit {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .thermostat-controller {
            background: linear-gradient(135deg, #EDD4B4 0%, #FAFAF0 100%);
            border: 1px solid rgba(139, 69, 19, 0.3);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            width: 100%;
        }

        .thermostat-controller::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: gentle-shimmer 8s infinite linear;
            pointer-events: none;
        }

        .thermostat-controller:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .temp-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(139, 69, 19, 0.2);
            color: #5D4037;
            font-size: 1.5em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            user-select: none;
        }

        .temp-btn:hover {
            background: #2E7D32;
            border-color: #1B5E20;
            color: #FFFFFF;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.3);
        }

        .temp-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .temp-btn.decrease:hover {
            background: #1976D2;
            border-color: #1565C0;
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.3);
        }

        .temp-btn.increase:hover {
            background: #D32F2F;
            border-color: #C62828;
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.3);
        }

        .temp-slider {
            width: 100%;
            height: 10px;
            background: rgba(139, 69, 19, 0.2);
            border-radius: 5px;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(139, 69, 19, 0.1);
            flex: 1;
            margin: 0 15px;
        }

        .temp-slider .level-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976D2, #2E7D32, #D32F2F);
            border-radius: 5px;
            transition: width 0.3s ease;
            position: relative;
        }

        /* Override specifico per termostato */
        .temp-slider .level-thumb {
            top: -10px;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(139, 69, 19, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: 700;
        }

        .temp-slider .level-thumb.dragging {
            transform: scale(1.3);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.5);
            border-color: rgba(139, 69, 19, 0.8);
            transition: none;
        }

        .level-slider-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 15px 0;
        }

        .climate-status {
            margin: 20px 0 10px 0;
            position: relative;
            z-index: 2;
        }

        .climate-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.4s ease;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(139, 69, 19, 0.2);
        }

        .climate-indicator.heating {
            background: rgba(244, 67, 54, 0.3);
            border-color: rgba(244, 67, 54, 0.5);
            color: #D32F2F;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.2);
        }

        .climate-indicator.cooling {
            background: rgba(33, 150, 243, 0.3);
            border-color: rgba(33, 150, 243, 0.5);
            color: #1976D2;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }

        .climate-indicator.neutral {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
            color: #388E3C;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        }

        .climate-indicator.off {
            background: rgba(108, 117, 125, 0.2);
            border-color: rgba(108, 117, 125, 0.3);
            color: #6C757D;
        }

        .climate-icon {
            font-size: 1.2em;
            animation: pulse-climate 2s infinite;
        }

        .climate-indicator.heating .climate-icon {
            animation: pulse-climate 1.5s infinite;
        }

        .climate-indicator.cooling .climate-icon {
            animation: pulse-climate 1.5s infinite;
        }

        .climate-indicator.neutral .climate-icon {
            animation: pulse-climate 3s infinite;
        }

        /* ===== STATUS PANEL ===== */
        .status-panel {
            background: var(--aman-green);
            color: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-right {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--red);
        }

        .status-indicator.connected {
            background: var(--green);
        }

        .status-indicator.connecting {
            background: var(--orange);
        }

        .header-btn {
            padding: 8px 16px;
            background: var(--aman-green);
            color: var(--white);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(26, 74, 58, 0.8);
        }

        /* ===== CONSOLE PANEL ===== */
        .console-panel {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40vh;
            background: rgba(0, 0, 0, 0.95);
            color: var(--green);
            font-family: 'Courier New', monospace;
            z-index: 1000;
            flex-direction: column;
        }

        .console-panel.show {
            display: flex;
        }

        .console-header {
            background: var(--aman-green);
            color: var(--white);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .console-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--aman-green);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 18px;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .message-sent { color: #ff9966; }
        .message-received { color: #66ff99; }
        .message-info { color: #66ccff; }
        .message-error { color: #ff6666; }

        /* ===== CONSOLE FILTER CONTROLS ===== */
        .console-filter {
            background: rgba(26, 74, 58, 0.8);
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
        }

        .filter-label {
            color: var(--white);
            font-weight: bold;
        }

        .filter-status {
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--aman-gold);
            color: var(--aman-green);
            font-weight: bold;
            font-size: 11px;
        }

        .filtered-message {
            opacity: 0.6;
            border-left: 3px solid var(--aman-gold);
            padding-left: 10px;
            margin: 5px 0;
        }

        /* ===== INFO MODAL ===== */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .info-modal.show {
            display: flex;
        }

        .info-modal-content {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: slideInUp 0.3s ease;
            position: relative;
        }

        .info-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-medium);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .info-close-btn:hover {
            background: var(--gray-light);
            color: var(--aman-green);
        }

        .info-modal-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--aman-gold);
            padding-bottom: 20px;
        }

        .info-modal-title {
            color: var(--aman-green);
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-modal-subtitle {
            color: var(--gray-medium);
            font-size: 14px;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section-title {
            color: var(--aman-green);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(26, 74, 58, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--aman-gold);
        }

        .info-label {
            font-weight: 500;
            color: var(--aman-green);
        }

        .info-value {
            font-weight: 600;
            color: var(--gray-medium);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .content-container {
                padding: 15px;
            }
            
            .status-panel {
                flex-direction: column;
                gap: 15px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 14px;
            }

            .room-title {
                font-size: 24px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="logo">
                <img src="assets/images/AmanVeniceCameraLogo.png" alt="AMAN Venice Logo" class="logo-image" id="logoImage" style="display: none;">
                <div class="logo-fallback" id="logoFallback">AMAN</div>
            </div>
            <h1 class="login-title" id="loginTitle">Room Control</h1>
            <input type="password" class="password-input" id="passwordInput" placeholder="Enter password" maxlength="10">
            <button class="login-button" onclick="doLogin()">Enter</button>
            <div class="error-message" id="errorMessage"></div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Initializing Dashboard</div>
            <div class="loading-details" id="loadingDetails">Setting up room systems...</div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <!-- Header -->
        <header class="header"></header>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-tabs" id="navigationTabs">
                <!-- Navigation tabs will be generated dynamically -->
            </div>
        </div>

        <!-- Content -->
        <div class="content-container">
            <div id="tabsContainer">
                <!-- Tab contents will be generated dynamically -->
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <div class="status-left">
                <div class="status-item">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <div>
                        <div style="font-weight: bold;" id="roomNameStatus">Room</div>
                        <div id="connectionStatus">Disconnected</div>
                    </div>
                </div>
            </div>
            <div class="status-right">
                <button class="header-btn" onclick="showInfo()">RIMO</button>
                <button class="header-btn" onclick="toggleConsole()">Console</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <button class="info-close-btn" onclick="hideInfo()">&times;</button>
            
            <div class="info-modal-header">
                <h2 class="info-modal-title" id="infoTitle">AMAN Venice - Room</h2>
                <p class="info-modal-subtitle" id="infoSubtitle">Complete Control Dashboard - Developer: RIMO</p>
            </div>

            <div class="info-section">
                <h3 class="info-section-title">üè† System Information</h3>
                <div class="system-info-grid">
                    <div class="info-item">
                        <span class="info-label">Room Number:</span>
                        <span class="info-value" id="infoRoomNumber">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Version:</span>
                        <span class="info-value" id="infoVersion">v1.0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Update:</span>
                        <span class="info-value" id="infoLastUpdate">Never</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">MQTT Status:</span>
                        <span class="info-value" id="infoMqttStatus">Disconnected</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h3 class="info-section-title">üì° Connection Details</h3>
                <div class="system-info-grid">
                    <div class="info-item">
                        <span class="info-label">MQTT Broker:</span>
                        <span class="info-value">broker.emqx.io:8084</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Publish Topic:</span>
                        <span class="info-value">Camere/Hmi</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Subscribe Topic:</span>
                        <span class="info-value">Camere/Plc</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="infoClientId">Offline</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Console -->
    <div class="console-panel" id="consolePanel">
        <div class="console-header">
            <div id="consoleTitle">üì° MQTT Console - Camera 2</div>
            <div>
                <button class="header-btn" onclick="clearConsole()">Clear</button>
                <button class="header-btn" onclick="hideConsole()">Close</button>
            </div>
        </div>
        <div class="console-filter">
            <span class="filter-label">üîç Filter:</span>
            <span class="filter-status">Camera 2 Only</span>
            <span style="color: rgba(255,255,255,0.7); font-size: 11px;">Showing only messages with "nCamera": 2</span>
        </div>
        <div class="console-content" id="consoleContent">
            <div class="message-info">[SYSTEM] Console initialized - Filtering messages for Camera 2</div>
        </div>
    </div>

    <button class="console-toggle" onclick="toggleConsole()">üì°</button>

    <!-- MQTT Manager -->
    <script>
        class MQTTManager {
            constructor() {
                this.client = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 5000;
                
                this.config = {
                    broker: 'broker.emqx.io',
                    port: 8084,
                    protocol: 'wss',
                    topicSubscribe: 'Camere/Plc',
                    topicPublish: 'Camere/Hmi',
                    qos: 1,
                    clientId: `aman_venice_${Math.random().toString(16).substr(2, 8)}`
                };
                
                this.messageHandlers = [];
                this.connectionHandlers = [];
            }
            
            async connect() {
                try {
                    if (typeof Paho === 'undefined' || !Paho.MQTT) {
                        throw new Error('Libreria Paho MQTT non disponibile');
                    }
                    
                    this.client = new Paho.MQTT.Client(
                        this.config.broker,
                        this.config.port,
                        this.config.clientId
                    );
                    
                    this.client.onConnectionLost = this.onConnectionLost.bind(this);
                    this.client.onMessageArrived = this.onMessageArrived.bind(this);
                    
                    const connectOptions = {
                        onSuccess: this.onConnect.bind(this),
                        onFailure: this.onConnectFailure.bind(this),
                        useSSL: true,
                        cleanSession: true,
                        keepAliveInterval: 60,
                        timeout: 10
                    };
                    
                    this.client.connect(connectOptions);
                    
                } catch (error) {
                    this.notifyConnectionHandlers(false, error.message);
                }
            }
            
            onConnect() {
                this.isConnected = true;
                this.reconnectAttempts = 0;
                this.subscribe();
                this.notifyConnectionHandlers(true);
            }
            
            onConnectFailure(error) {
                this.isConnected = false;
                this.scheduleReconnect();
                this.notifyConnectionHandlers(false, error.errorMessage);
            }
            
            onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    this.isConnected = false;
                    this.scheduleReconnect();
                    this.notifyConnectionHandlers(false, responseObject.errorMessage);
                }
            }
            
            subscribe() {
                if (!this.client || !this.isConnected) return;
                
                this.client.subscribe(this.config.topicSubscribe, {
                    qos: this.config.qos,
                    onSuccess: () => {},
                    onFailure: (error) => {}
                });
            }
            
            onMessageArrived(message) {
                try {
                    const topic = message.destinationName;
                    const payload = message.payloadString;
                    
                    let jsonData;
                    try {
                        jsonData = JSON.parse(payload);
                    } catch (parseError) {
                        return;
                    }
                    
                    this.notifyMessageHandlers(topic, jsonData);
                    
                } catch (error) {
                    console.error('‚ùå Errore elaborazione messaggio:', error);
                }
            }
            
            publish(payload) {
                if (!this.client || !this.isConnected) {
                    return false;
                }
                
                try {
                    const message = new Paho.MQTT.Message(JSON.stringify(payload));
                    message.destinationName = this.config.topicPublish;
                    message.qos = this.config.qos;
                    
                    this.client.send(message);
                    return true;
                    
                } catch (error) {
                    return false;
                }
            }
            
            scheduleReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    return;
                }
                
                this.reconnectAttempts++;
                
                setTimeout(() => {
                    this.connect();
                }, this.reconnectDelay);
            }
            
            onMessage(handler) {
                if (typeof handler === 'function') {
                    this.messageHandlers.push(handler);
                }
            }
            
            onConnection(handler) {
                if (typeof handler === 'function') {
                    this.connectionHandlers.push(handler);
                }
            }
            
            notifyMessageHandlers(topic, data) {
                this.messageHandlers.forEach(handler => {
                    try {
                        handler(topic, data);
                    } catch (error) {
                        console.error('‚ùå Errore message handler:', error);
                    }
                });
            }
            
            notifyConnectionHandlers(connected, error = null) {
                this.connectionHandlers.forEach(handler => {
                    try {
                        handler(connected, error);
                    } catch (error) {
                        console.error('‚ùå Errore connection handler:', error);
                    }
                });
            }
            
            disconnect() {
                if (this.client && this.isConnected) {
                    this.client.disconnect();
                }
                this.isConnected = false;
            }
        }
    </script>

    <!-- Load Core Modules -->
    <script src="js/core/dashboard-core.js"></script>
    <script src="js/core/room-manager.js"></script>
    <script src="js/core/control-factory.js"></script>

    <!-- Main Application Script -->
    <script>
        // ===== GLOBAL VARIABLES =====
        let dashboardCore = null;
        let roomManager = null;
        let controlFactory = null;
        let currentRoomNumber = 2; // Camera di default
        
        // ===== CONSOLE FILTERING =====
        function isMessageForCurrentRoom(messageData) {
            // Controlla se il messaggio ha il parametro nCamera corrispondente alla camera corrente
            if (typeof messageData === 'object' && messageData !== null) {
                return messageData.nCamera === currentRoomNumber;
            }
            return false;
        }
        
        function logFilteredMessage(type, header, data, isFiltered = false) {
            const consoleContent = document.getElementById('consoleContent');
            if (!consoleContent) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const messageClass = isFiltered ? 'filtered-message' : '';
            
            let messageHtml = `<div class="message-${type} ${messageClass}">`;
            messageHtml += `[${timestamp}] ${header}`;
            
            if (data) {
                if (typeof data === 'object') {
                    messageHtml += `<br>${JSON.stringify(data, null, 2)}`;
                } else {
                    messageHtml += ` ${data}`;
                }
            }
            
            if (isFiltered) {
                messageHtml += ` <span style="color: var(--aman-gold); font-weight: bold;">[CAMERA ${currentRoomNumber}]</span>`;
            }
            
            messageHtml += '</div>';
            
            consoleContent.innerHTML += messageHtml;
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }
        
        function clearConsole() {
            const consoleContent = document.getElementById('consoleContent');
            if (consoleContent) {
                consoleContent.innerHTML = `<div class="message-info">[SYSTEM] Console cleared - Filtering messages for Camera ${currentRoomNumber}</div>`;
            }
        }
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Starting AMAN Venice Modular Dashboard...');
                
                // Extract room number from URL (room-XX.html)
                currentRoomNumber = extractRoomNumber();
                console.log(`üè† Detected Room: ${currentRoomNumber}`);
                
                // Update console title
                const consoleTitle = document.getElementById('consoleTitle');
                if (consoleTitle) {
                    consoleTitle.textContent = `üì° MQTT Console - Camera ${currentRoomNumber}`;
                }
                
                // Initialize core system
                dashboardCore = new AmanDashboardCore();
                await dashboardCore.init(currentRoomNumber);
                
                // Override the logToConsole method to filter messages
                const originalLogToConsole = dashboardCore.logToConsole;
                dashboardCore.logToConsole = function(type, header, data) {
                    // Check if this is an MQTT message
                    if (header.includes('MQTT') && data && typeof data === 'object') {
                        // Check if message is for current room
                        if (isMessageForCurrentRoom(data)) {
                            logFilteredMessage(type, header, data, true);
                        } else {
                            // Don't log messages for other rooms
                            return;
                        }
                    } else {
                        // Log system messages normally
                        logFilteredMessage(type, header, data, false);
                    }
                };
                
                // Initialize room manager with error handling
                try {
                    roomManager = new AmanRoomManager(dashboardCore);
                    console.log('‚úÖ RoomManager initialized:', roomManager);
                } catch (error) {
                    console.error('‚ùå Failed to initialize RoomManager:', error);
                    roomManager = null;
                }

                // Initialize control factory
                try {
                    controlFactory = new AmanControlFactory(dashboardCore);
                    controlFactory.initialize();
                    console.log('‚úÖ ControlFactory initialized:', controlFactory);
                } catch (error) {
                    console.error('‚ùå Failed to initialize ControlFactory:', error);
                    controlFactory = null;
                }
                
                console.log('‚úÖ Modular dashboard system ready');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize dashboard:', error);
            }
        });
        
        // ===== UTILITY FUNCTIONS =====
        function extractRoomNumber() {
            // Extract from URL like room-02.html or default to 02
            const path = window.location.pathname;
            const match = path.match(/room-(\d+)\.html/);
            return match ? parseInt(match[1]) : 2;
        }
        
        // ===== LOGIN FUNCTIONS =====
        async function doLogin() {
            const password = document.getElementById('passwordInput')?.value;
            const errorMsg = document.getElementById('errorMessage');
            
            if (errorMsg) errorMsg.textContent = '';
            
            try {
                await dashboardCore.doLogin(password);
                
                // Show loading
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'flex';
                
                // Load dashboard
                await loadDashboard();
                
            } catch (error) {
                if (errorMsg) errorMsg.textContent = error.message;
                const input = document.getElementById('passwordInput');
                if (input) input.value = '';
            }
        }
        
        async function loadDashboard() {
            try {
                // Load dashboard core
                await dashboardCore.loadDashboard();
        
                // SAFE: Controlla che roomManager esista
                if (!roomManager) {
                    console.warn('‚ö†Ô∏è roomManager is null, reinitializing...');
                    roomManager = new AmanRoomManager(dashboardCore);
                }
        
                // SAFE: Controlla che generateLayout esista
                if (!roomManager || typeof roomManager.generateLayout !== 'function') {
                    throw new Error('RoomManager not properly initialized');
                }
        
                // Generate layout
                await roomManager.generateLayout();
        
                // Show main app
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('mainApp').classList.add('show');
        
                // Update status
                dashboardCore.updateInfoModal();
        
                console.log('üéâ Dashboard loaded successfully!');
        
            } catch (error) {
                console.error('‚ùå Failed to load dashboard:', error);
                alert('Failed to load dashboard: ' + error.message);
        
                // Return to login
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }        

        // ===== UI FUNCTIONS =====
        function switchTab(tabId, buttonElement = null) {
            if (roomManager) {
                roomManager.switchTab(tabId, buttonElement);
            }
        }
        
        function showInfo() {
            const modal = document.getElementById('infoModal');
            if (modal) modal.classList.add('show');
        }
        
        function hideInfo() {
            const modal = document.getElementById('infoModal');
            if (modal) modal.classList.remove('show');
        }
        
        function toggleConsole() {
            const panel = document.getElementById('consolePanel');
            if (panel) panel.classList.toggle('show');
        }
        
        function hideConsole() {
            const panel = document.getElementById('consolePanel');
            if (panel) panel.classList.remove('show');
        }
        
        // ===== EVENT LISTENERS =====
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen && loginScreen.style.display !== 'none') {
                    doLogin();
                }
            }
        });
        
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('infoModal');
            if (modal && e.target === modal) {
                hideInfo();
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideInfo();
                hideConsole();
            }
        });
        
        // ===== GLOBAL API =====
        window.AmanAPI = {
            getRoomNumber: () => dashboardCore?.roomNumber,
            getRoomName: () => dashboardCore?.roomConfig?.name,
            sendMessage: (payload) => {
                // Ensure the message includes the current room number
                if (payload && typeof payload === 'object') {
                    payload.nCamera = currentRoomNumber;
                }
                return dashboardCore?.sendMQTTMessage(payload);
            },
            isConnected: () => dashboardCore?.connected,
            getControl: (id) => dashboardCore?.getControl(id),
            getAllControls: () => dashboardCore?.getAllControls(),
            log: (type, header, data) => {
                // Use the filtered logging function
                if (data && typeof data === 'object' && isMessageForCurrentRoom(data)) {
                    logFilteredMessage(type, header, data, true);
                } else if (!data || typeof data !== 'object') {
                    logFilteredMessage(type, header, data, false);
                }
            },
            
            // Debug
            getCore: () => dashboardCore,
            getManager: () => roomManager,
            getFactory: () => controlFactory,
            getCurrentRoom: () => currentRoomNumber,
            clearConsole: clearConsole
        };
        
        console.log('‚úÖ AMAN Venice Modular Dashboard System ready with filtered console');
        console.log(`üè† Current Room: ${currentRoomNumber} - Console will show only messages with "nCamera": ${currentRoomNumber}`);
    </script>
</body>
</html>