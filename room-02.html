<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMAN Venice - Room 02</title>
    
    <!-- MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        /* ===== AMAN VENICE BASE STYLES ===== */
        :root {
            --aman-green: #1a4a3a;
            --aman-gold: #d4af37;
            --wine-medium: #911e42;
            --wine-dark: #641428;
            --gray-light: #e6e6e6;
            --gray-medium: #999999;
            --white: #ffffff;
            --black: #000000;
            --blue: #0066ff;
            --green: #00ff00;
            --yellow: #ffff00;
            --orange: #ff9933;
            --red: #ff3333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .logo {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }

        .logo-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .logo-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        .login-title {
            color: var(--white);
            font-size: 28px;
            margin-bottom: 30px;
            font-weight: 300;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            backdrop-filter: blur(5px);
        }

        .password-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .password-input:focus {
            outline: none;
            border-color: var(--aman-gold);
            background: rgba(255, 255, 255, 0.3);
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(145deg, var(--aman-green), var(--aman-gold));
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .error-message {
            color: #ff6b6b;
            margin-top: 15px;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* ===== LOADING SCREEN ===== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .loading-container {
            text-align: center;
            color: var(--white);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 300;
            opacity: 0.9;
        }

        .loading-details {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== MAIN APP ===== */
        .main-app {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .main-app.show {
            display: flex;
        }

        .header {
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .nav-container {
            background: linear-gradient(135deg, var(--aman-green), var(--aman-gold));
            border-bottom: 2px solid var(--aman-gold);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 15px 25px;
            background: var(--aman-green);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: rgba(26, 74, 58, 0.8);
        }

        .nav-tab.active {
            background: var(--aman-gold);
            color: var(--aman-green);
            border-bottom-color: var(--wine-medium);
        }

        .content-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== ROOM HEADER ===== */
        .room-header {
            background: var(--aman-green);
            color: var(--aman-gold);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .room-title {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .room-subtitle {
            font-size: 16px;
            opacity: 0.8;
        }

        /* ===== CONTROLS GRID ===== */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .control-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        /* ===== DALI CONTROLS ===== */
        .dali-controller {
            background: linear-gradient(135deg, #EDD4B4 0%, #FAFAF0 100%);
            border: 1px solid rgba(139, 69, 19, 0.3);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            width: 100%;
        }

        .dali-controller:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .uniform-element {
            font-size: 1em;
            font-weight: 500;
            padding: 12px 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(139, 69, 19, 0.2);
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .group-label {
            color: #8B4513;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
            font-weight: 600;
        }

        .main-controls {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            gap: 15px;
            margin: 20px 0;
            position: relative;
            z-index: 2;
        }

        .level-display {
            flex: 1;
        }

        .level-value {
            color: #5D4037;
            width: 100%;
            min-width: 80px;
        }

        .level-value.on {
            background: rgba(255, 193, 7, 0.4);
            color: #8B4513;
            border-color: rgba(255, 193, 7, 0.5);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.25);
        }

        .level-value.off {
            background: rgba(108, 117, 125, 0.3);
            color: #6C757D;
            border-color: rgba(108, 117, 125, 0.4);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.1);
        }

        .level-unit {
            font-size: 1em;
            opacity: 0.8;
        }

        .power-controls {
            display: flex;
            gap: 10px;
        }

        .power-btn {
            color: #5D4037;
            cursor: pointer;
            min-width: 70px;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 500;
            border: none;
        }

        .power-btn:hover {
            background: rgba(139, 69, 19, 0.25);
            border-color: rgba(139, 69, 19, 0.4);
            transform: translateY(-2px);
            color: #8B4513;
        }

        .power-btn.active {
            background: rgba(139, 69, 19, 0.3);
            border-color: rgba(139, 69, 19, 0.5);
            color: #8B4513;
            font-weight: 600;
        }

        .power-btn.on-active {
            background: rgba(255, 193, 7, 0.4);
            border-color: rgba(255, 193, 7, 0.5);
            color: #8B4513;
        }

        .level-control {
            margin: 30px 0;
            position: relative;
            z-index: 2;
        }

        .level-label {
            font-size: 0.9em;
            color: #5D4037;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .level-slider-container {
            position: relative;
            padding: 10px 0;
        }

        .level-slider {
            width: 100%;
            height: 8px;
            background: rgba(139, 69, 19, 0.2);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(139, 69, 19, 0.1);
        }

        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(139, 69, 19, 0.8), rgba(255, 193, 7, 0.8));
            border-radius: 4px;
            transition: width 0.3s ease;
            position: relative;
        }

        .level-thumb {
            position: absolute;
            top: -8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            border: 2px solid rgba(139, 69, 19, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .level-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.3);
            border-color: rgba(139, 69, 19, 0.7);
        }

        .level-thumb.active {
            background: rgba(255, 193, 7, 0.9);
            border-color: rgba(255, 193, 7, 0.7);
        }

        .slider-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.7em;
            color: rgba(93, 64, 55, 0.7);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            font-size: 0.85em;
            color: #5D4037;
            position: relative;
            z-index: 2;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.on {
            background: rgba(255, 193, 7, 0.8);
        }

        .status-dot.off {
            background: rgba(108, 117, 125, 0.8);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* ===== STATUS PANEL ===== */
        .status-panel {
            background: var(--aman-green);
            color: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-right {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--red);
        }

        .status-indicator.connected {
            background: var(--green);
        }

        .status-indicator.connecting {
            background: var(--orange);
        }

        .header-btn {
            padding: 8px 16px;
            background: var(--aman-green);
            color: var(--white);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(26, 74, 58, 0.8);
        }

        /* ===== CONSOLE PANEL ===== */
        .console-panel {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40vh;
            background: rgba(0, 0, 0, 0.95);
            color: var(--green);
            font-family: 'Courier New', monospace;
            z-index: 1000;
            flex-direction: column;
        }

        .console-panel.show {
            display: flex;
        }

        .console-header {
            background: var(--aman-green);
            color: var(--white);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .console-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--aman-green);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 18px;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .message-sent { color: #ff9966; }
        .message-received { color: #66ff99; }
        .message-info { color: #66ccff; }
        .message-error { color: #ff6666; }

        /* ===== INFO MODAL ===== */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .info-modal.show {
            display: flex;
        }

        .info-modal-content {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: slideInUp 0.3s ease;
            position: relative;
        }

        .info-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-medium);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .info-close-btn:hover {
            background: var(--gray-light);
            color: var(--aman-green);
        }

        .info-modal-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--aman-gold);
            padding-bottom: 20px;
        }

        .info-modal-title {
            color: var(--aman-green);
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-modal-subtitle {
            color: var(--gray-medium);
            font-size: 14px;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section-title {
            color: var(--aman-green);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(26, 74, 58, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--aman-gold);
        }

        .info-label {
            font-weight: 500;
            color: var(--aman-green);
        }

        .info-value {
            font-weight: 600;
            color: var(--gray-medium);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .content-container {
                padding: 15px;
            }
            
            .status-panel {
                flex-direction: column;
                gap: 15px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 14px;
            }

            .room-title {
                font-size: 24px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="logo">
                <img src="assets/images/AmanVeniceCameraLogo.png" alt="AMAN Venice Logo" class="logo-image" id="logoImage" style="display: none;">
                <div class="logo-fallback" id="logoFallback">AMAN</div>
            </div>
            <h1 class="login-title" id="loginTitle">Room 02 Control</h1>
            <input type="password" class="password-input" id="passwordInput" placeholder="Enter password" maxlength="10">
            <button class="login-button" onclick="doLogin()">Enter</button>
            <div class="error-message" id="errorMessage"></div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Initializing Room 02 Dashboard</div>
            <div class="loading-details" id="loadingDetails">Setting up room systems...</div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <!-- Header -->
        <header class="header"></header>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-tabs" id="navigationTabs">
                <button class="nav-tab active" onclick="switchTab('bedroom', this)">🛏️ Bedroom</button>
                <button class="nav-tab" onclick="switchTab('settings', this)">⚙️ Settings</button>
            </div>
        </div>

        <!-- Content -->
        <div class="content-container">
            <div id="tabsContainer">
                <!-- Bedroom Tab -->
                <div id="bedroom-tab" class="tab-content active">
                    <div class="room-header">
                        <h2 class="room-title">🛏️ Bedroom</h2>
                        <p class="room-subtitle">Room 02 - Lighting Control</p>
                    </div>

                    <div class="controls-grid" id="daliControlsStatic">
                        <!-- MAIN LIGHT -->
                        <div class="control-container">
                            <div class="dali-controller" id="dali_main">
                                <div class="group-label uniform-element">💡 Main Light</div>
                                
                                <div class="main-controls">
                                    <div class="level-display">
                                        <div class="level-value uniform-element off" id="main_display">
                                            0<span class="level-unit">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="power-controls">
                                        <button class="power-btn uniform-element active" id="main_off" onclick="setDALIControl('main', 'off')">OFF</button>
                                        <button class="power-btn uniform-element" id="leftabat_on" onclick="setDALIControl('leftabat', 'on')">ON</button>
                                    </div>
                                </div>
                                
                                <div class="level-control">
                                    <div class="level-label">Light Level Setting</div>
                                    <div class="level-slider-container">
                                        <div class="level-slider" onclick="adjustDALILevel(event, 'leftabat')">
                                            <div class="level-fill" id="leftabat_fill" style="width: 0%"></div>
                                            <div class="level-thumb" id="leftabat_thumb" style="left: calc(0% - 12px)"></div>
                                        </div>
                                        <div class="slider-scale">
                                            <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="status-indicator">
                                    <div class="status-dot off" id="leftabat_dot"></div>
                                    <span id="leftabat_status">Lights off</span>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT ABAT JOUR -->
                        <div class="control-container">
                            <div class="dali-controller" id="dali_rightabat">
                                <div class="group-label uniform-element">💡 Right Abat Jour</div>
                                
                                <div class="main-controls">
                                    <div class="level-display">
                                        <div class="level-value uniform-element off" id="rightabat_display">
                                            0<span class="level-unit">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="power-controls">
                                        <button class="power-btn uniform-element active" id="rightabat_off" onclick="setDALIControl('rightabat', 'off')">OFF</button>
                                        <button class="power-btn uniform-element" id="rightabat_on" onclick="setDALIControl('rightabat', 'on')">ON</button>
                                    </div>
                                </div>
                                
                                <div class="level-control">
                                    <div class="level-label">Light Level Setting</div>
                                    <div class="level-slider-container">
                                        <div class="level-slider" onclick="adjustDALILevel(event, 'rightabat')">
                                            <div class="level-fill" id="rightabat_fill" style="width: 0%"></div>
                                            <div class="level-thumb" id="rightabat_thumb" style="left: calc(0% - 12px)"></div>
                                        </div>
                                        <div class="slider-scale">
                                            <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="status-indicator">
                                    <div class="status-dot off" id="rightabat_dot"></div>
                                    <span id="rightabat_status">Lights off</span>
                                </div>
                            </div>
                        </div>

                        <!-- DESK LIGHT -->
                        <div class="control-container">
                            <div class="dali-controller" id="dali_desk">
                                <div class="group-label uniform-element">💻 Desk Light</div>
                                
                                <div class="main-controls">
                                    <div class="level-display">
                                        <div class="level-value uniform-element off" id="desk_display">
                                            0<span class="level-unit">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="power-controls">
                                        <button class="power-btn uniform-element active" id="desk_off" onclick="setDALIControl('desk', 'off')">OFF</button>
                                        <button class="power-btn uniform-element" id="desk_on" onclick="setDALIControl('desk', 'on')">ON</button>
                                    </div>
                                </div>
                                
                                <div class="level-control">
                                    <div class="level-label">Light Level Setting</div>
                                    <div class="level-slider-container">
                                        <div class="level-slider" onclick="adjustDALILevel(event, 'desk')">
                                            <div class="level-fill" id="desk_fill" style="width: 0%"></div>
                                            <div class="level-thumb" id="desk_thumb" style="left: calc(0% - 12px)"></div>
                                        </div>
                                        <div class="slider-scale">
                                            <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="status-indicator">
                                    <div class="status-dot off" id="desk_dot"></div>
                                    <span id="desk_status">Lights off</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content">
                    <div class="room-header">
                        <h2 class="room-title">⚙️ Settings</h2>
                        <p class="room-subtitle">Room 02 - System Settings</p>
                    </div>

                    <div class="controls-grid">
                        <div class="control-container">
                            <h3>System Information</h3>
                            <p><strong>Room:</strong> 02</p>
                            <p><strong>Type:</strong> Bedroom</p>
                            <p><strong>MQTT Status:</strong> <span id="mqttStatus">Disconnected</span></p>
                            <p><strong>Last Update:</strong> <span id="lastUpdate">Never</span></p>
                        </div>
                        
                        <div class="control-container">
                            <h3>Test Controls</h3>
                            <button class="login-button" onclick="testAllLights()" style="margin: 10px 0;">Test All Lights</button>
                            <button class="login-button" onclick="resetAllLights()" style="margin: 10px 0;">Reset All Lights</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <div class="status-left">
                <div class="status-item">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <div>
                        <div style="font-weight: bold;" id="roomNameStatus">Room 02</div>
                        <div id="connectionStatus">Disconnected</div>
                    </div>
                </div>
            </div>
            <div class="status-right">
                <button class="header-btn" onclick="showInfo()">RIMO</button>
                <button class="header-btn" onclick="toggleConsole()">Console</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <button class="info-close-btn" onclick="hideInfo()">&times;</button>
            
            <div class="info-modal-header">
                <h2 class="info-modal-title" id="infoTitle">AMAN Venice - Room 02</h2>
                <p class="info-modal-subtitle" id="infoSubtitle">Complete Control Dashboard - Developer: RIMO</p>
            </div>

            <div class="info-section">
                <h3 class="info-section-title">🏠 System Information</h3>
                <div class="system-info-grid">
                    <div class="info-item">
                        <span class="info-label">Room Number:</span>
                        <span class="info-value" id="infoRoomNumber">02</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Version:</span>
                        <span class="info-value" id="infoVersion">Room 02 v1.0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Update:</span>
                        <span class="info-value" id="infoLastUpdate">Never</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">MQTT Status:</span>
                        <span class="info-value" id="infoMqttStatus">Disconnected</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <h3 class="info-section-title">📡 Connection Details</h3>
                <div class="system-info-grid">
                    <div class="info-item">
                        <span class="info-label">MQTT Broker:</span>
                        <span class="info-value">broker.emqx.io:8084</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Publish Topic:</span>
                        <span class="info-value">Camere/Hmi</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Subscribe Topic:</span>
                        <span class="info-value">Camere/Plc</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="infoClientId">Offline</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Console -->
    <div class="console-panel" id="consolePanel">
        <div class="console-header">
            <div id="consoleTitle">📡 MQTT Console - Room 02</div>
            <div>
                <button class="header-btn" onclick="hideConsole()">Close</button>
            </div>
        </div>
        <div class="console-content" id="consoleContent">
            <div class="message-info">[SYSTEM] Room 02 dashboard console initialized</div>
        </div>
    </div>

    <button class="console-toggle" onclick="toggleConsole()">📡</button>

    <script>
        // ===== GLOBAL VARIABLES =====
        let mqttManager = null;
        let connected = false;
        let lastUpdateTime = 'Never';
        
        // DALI Controls state
        const daliControls = {
            main: { level: 0, isOn: false, mqttName: 'Totale' },
            courtesy: { level: 0, isOn: false, mqttName: 'Parziale' },
            bed: { level: 0, isOn: false, mqttName: 'Letto' },
            leftabat: { level: 0, isOn: false, mqttName: 'ComodinoSx' },
            rightabat: { level: 0, isOn: false, mqttName: 'ComodinoDx' },
            desk: { level: 0, isOn: false, mqttName: 'Scrivania' }
        };

        // ===== MQTT PROTOCOL =====
        class MQTTProtocol {
            static DALI_ZONES = {
                'nTota': { name: 'Main', label: 'Illuminazione Principale' },
                'nParz': { name: 'Courtesy', label: 'Illuminazione Cortesia' },
                'nLett': { name: 'Bed', label: 'Illuminazione Letto' },
                'nCoSx': { name: 'LeftAbat', label: 'Abat Jour Sinistro' },
                'nCoDx': { name: 'RightAbat', label: 'Abat Jour Destro' },
                'nScri': { name: 'Desk', label: 'Illuminazione Scrivania' }
            };
            
            static CONTROL_TYPES = {
                DALI_LIGHTS: ['CameraLuci', 'BagnoLuci', 'SoggiornoLuci']
            };
            
            static parseDALIMessage(jsonData) {
                try {
                    if (!jsonData.nCamera || !jsonData.sNome || !jsonData.Timestamp) {
                        throw new Error('Messaggio DALI incompleto');
                    }
                    
                    if (!this.CONTROL_TYPES.DALI_LIGHTS.includes(jsonData.sNome)) {
                        return null;
                    }
                    
                    const zones = {};
                    Object.keys(this.DALI_ZONES).forEach(zoneKey => {
                        const levelKey = `${zoneKey}Liv`;
                        const setKey = `${zoneKey}Set`;
                        
                        if (jsonData.hasOwnProperty(levelKey) && jsonData.hasOwnProperty(setKey)) {
                            zones[zoneKey] = {
                                name: this.DALI_ZONES[zoneKey].name,
                                label: this.DALI_ZONES[zoneKey].label,
                                currentLevel: this.validateLevel(jsonData[levelKey]),
                                setpoint: this.validateLevel(jsonData[setKey]),
                                isOn: jsonData[levelKey] > 0
                            };
                        }
                    });
                    
                    let roomType = 'Unknown';
                    switch (jsonData.sNome) {
                        case 'CameraLuci': roomType = 'Bedroom'; break;
                        case 'BagnoLuci': roomType = 'Bathroom'; break;
                        case 'SoggiornoLuci': roomType = 'Living'; break;
                    }
                    
                    return {
                        timestamp: jsonData.Timestamp,
                        roomNumber: jsonData.nCamera,
                        roomType: roomType,
                        controlName: jsonData.sNome,
                        controlType: 'DALI_LIGHTS',
                        zones: zones,
                        raw: jsonData
                    };
                    
                } catch (error) {
                    console.error('❌ Errore parsing messaggio DALI:', error);
                    return null;
                }
            }
            
            static validateLevel(level) {
                const numLevel = parseInt(level);
                if (isNaN(numLevel)) return 0;
                return Math.max(0, Math.min(100, numLevel));
            }
            
            static identifyMessageType(jsonData) {
                if (!jsonData.sNome) return 'UNKNOWN';
                
                if (this.CONTROL_TYPES.DALI_LIGHTS.includes(jsonData.sNome)) {
                    return 'DALI_LIGHTS';
                }
                
                return 'UNKNOWN';
            }
        }

        // ===== MQTT MANAGER =====
        class MQTTManager {
            constructor() {
                this.client = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 5000;
                
                this.config = {
                    broker: 'broker.emqx.io',
                    port: 8084,
                    protocol: 'wss',
                    topicSubscribe: 'Camere/Plc',
                    topicPublish: 'Camere/Hmi',
                    qos: 1,
                    clientId: `aman_venice_room02_${Math.random().toString(16).substr(2, 8)}`
                };
                
                this.messageHandlers = [];
                this.connectionHandlers = [];
            }
            
            async connect() {
                try {
                    console.log('🔌 Connessione al broker MQTT...');
                    
                    if (typeof Paho === 'undefined' || !Paho.MQTT) {
                        throw new Error('Libreria Paho MQTT non disponibile');
                    }
                    
                    this.client = new Paho.MQTT.Client(
                        this.config.broker,
                        this.config.port,
                        this.config.clientId
                    );
                    
                    this.client.onConnectionLost = this.onConnectionLost.bind(this);
                    this.client.onMessageArrived = this.onMessageArrived.bind(this);
                    
                    const connectOptions = {
                        onSuccess: this.onConnect.bind(this),
                        onFailure: this.onConnectFailure.bind(this),
                        useSSL: true,
                        cleanSession: true,
                        keepAliveInterval: 60,
                        timeout: 10
                    };
                    
                    this.client.connect(connectOptions);
                    
                } catch (error) {
                    console.error('❌ Errore inizializzazione MQTT:', error);
                    this.notifyConnectionHandlers(false, error.message);
                }
            }
            
            onConnect() {
                console.log('✅ Connesso al broker MQTT');
                this.isConnected = true;
                this.reconnectAttempts = 0;
                this.subscribe();
                this.notifyConnectionHandlers(true);
            }
            
            onConnectFailure(error) {
                console.error('❌ Errore connessione MQTT:', error.errorMessage);
                this.isConnected = false;
                this.scheduleReconnect();
                this.notifyConnectionHandlers(false, error.errorMessage);
            }
            
            onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.warn('⚠️ Connessione MQTT persa:', responseObject.errorMessage);
                    this.isConnected = false;
                    this.scheduleReconnect();
                    this.notifyConnectionHandlers(false, responseObject.errorMessage);
                }
            }
            
            subscribe() {
                if (!this.client || !this.isConnected) return;
                
                try {
                    this.client.subscribe(this.config.topicSubscribe, {
                        qos: this.config.qos,
                        onSuccess: () => {
                            console.log(`📡 Sottoscritto al topic: ${this.config.topicSubscribe}`);
                        },
                        onFailure: (error) => {
                            console.error('❌ Errore sottoscrizione:', error);
                        }
                    });
                } catch (error) {
                    console.error('❌ Errore sottoscrizione topic:', error);
                }
            }
            
            onMessageArrived(message) {
                try {
                    const topic = message.destinationName;
                    const payload = message.payloadString;
                    
                    console.log(`📨 Messaggio ricevuto su ${topic}:`, payload);
                    
                    let jsonData;
                    try {
                        jsonData = JSON.parse(payload);
                    } catch (parseError) {
                        console.error('❌ Errore parsing JSON:', parseError);
                        return;
                    }
                    
                    this.notifyMessageHandlers(topic, jsonData);
                    
                } catch (error) {
                    console.error('❌ Errore elaborazione messaggio:', error);
                }
            }
            
            publish(payload) {
                if (!this.client || !this.isConnected) {
                    console.warn('⚠️ MQTT non connesso, impossibile inviare messaggio');
                    return false;
                }
                
                try {
                    const message = new Paho.MQTT.Message(JSON.stringify(payload));
                    message.destinationName = this.config.topicPublish;
                    message.qos = this.config.qos;
                    
                    this.client.send(message);
                    
                    console.log(`📤 Messaggio inviato su ${this.config.topicPublish}:`, payload);
                    logToConsole('sent', 'MQTT Send', JSON.stringify(payload, null, 2));
                    return true;
                    
                } catch (error) {
                    console.error('❌ Errore invio messaggio:', error);
                    return false;
                }
            }
            
            scheduleReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.error('❌ Massimo numero di tentativi riconnessione raggiunto');
                    return;
                }
                
                this.reconnectAttempts++;
                console.log(`🔄 Tentativo riconnessione ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${this.reconnectDelay/1000}s...`);
                
                setTimeout(() => {
                    this.connect();
                }, this.reconnectDelay);
            }
            
            onMessage(handler) {
                if (typeof handler === 'function') {
                    this.messageHandlers.push(handler);
                }
            }
            
            onConnection(handler) {
                if (typeof handler === 'function') {
                    this.connectionHandlers.push(handler);
                }
            }
            
            notifyMessageHandlers(topic, data) {
                this.messageHandlers.forEach(handler => {
                    try {
                        handler(topic, data);
                    } catch (error) {
                        console.error('❌ Errore message handler:', error);
                    }
                });
            }
            
            notifyConnectionHandlers(connected, error = null) {
                this.connectionHandlers.forEach(handler => {
                    try {
                        handler(connected, error);
                    } catch (error) {
                        console.error('❌ Errore connection handler:', error);
                    }
                });
            }
            
            disconnect() {
                if (this.client && this.isConnected) {
                    this.client.disconnect();
                    console.log('🔌 Disconnesso da MQTT');
                }
                this.isConnected = false;
            }
        }

        // ===== INITIALIZATION =====
        async function initializeDashboard() {
            console.log('🏨 AMAN Venice Dashboard System');
            console.log('🔧 Initializing Room 02...');
            
            // Initialize logo
            initializeLogo();
            
            // Initialize DALI controls display
            Object.keys(daliControls).forEach(zone => {
                updateDALIDisplay(zone);
            });
            
            console.log('✅ Room 02 ready for login');
        }

        function initializeLogo() {
            setTimeout(() => {
                const logoImage = document.getElementById('logoImage');
                const logoFallback = document.getElementById('logoFallback');
                
                if (!logoImage || !logoFallback) return;
                
                logoImage.onload = () => {
                    logoImage.style.display = 'block';
                    logoFallback.style.display = 'none';
                };
                
                logoImage.onerror = () => {
                    logoFallback.style.display = 'flex';
                    logoImage.style.display = 'none';
                    
                    const logoBase64 = 'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120">
                            <defs>
                                <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#1a4a3a;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#d4af37;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle cx="60" cy="60" r="60" fill="url(#grad)"/>
                            <text x="60" y="40" font-family="serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">AMAN</text>
                            <text x="60" y="58" font-family="serif" font-size="11" text-anchor="middle" fill="white">VENICE</text>
                            <text x="60" y="75" font-family="serif" font-size="9" text-anchor="middle" fill="white">ROOM 02</text>
                            <circle cx="60" cy="60" r="55" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                        </svg>
                    `);
                    logoImage.src = logoBase64;
                };
                
                logoImage.src = 'assets/images/AmanVeniceCameraLogo.png';
            }, 100);
        }

        // ===== LOGIN FUNCTIONS =====
        async function doLogin() {
            const password = document.getElementById('passwordInput')?.value;
            const errorMsg = document.getElementById('errorMessage');
            
            if (errorMsg) errorMsg.textContent = '';
            
            try {
                if (password !== '02') {
                    throw new Error('Invalid password. Please enter "02" for Room 02.');
                }
                
                console.log('✅ Login successful for Room 02');
                
                // Show loading
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'flex';
                
                // Load dashboard
                await loadDashboard();
                
            } catch (error) {
                if (errorMsg) errorMsg.textContent = error.message;
                const input = document.getElementById('passwordInput');
                if (input) input.value = '';
            }
        }

        async function loadDashboard() {
            try {
                updateLoadingStatus('Loading room configuration...');
                await sleep(500);
                
                updateLoadingStatus('Initializing MQTT system...');
                await initializeMQTT();
                await sleep(300);
                
                updateLoadingStatus('Connecting to room systems...');
                await connectSystems();
                await sleep(300);
                
                updateLoadingStatus('Finalizing...');
                await sleep(200);
                
                // Show main app
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('mainApp').classList.add('show');
                
                // Update status
                updateInfoModal();
                
                console.log('🎉 Room 02 Dashboard loaded successfully!');
                logToConsole('info', 'Dashboard Ready', 'Room 02 loaded with MQTT integration');
                
            } catch (error) {
                console.error('❌ Failed to load dashboard:', error);
                alert('Failed to load dashboard: ' + error.message);
                
                // Return to login
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        async function initializeMQTT() {
            try {
                console.log('📡 Initializing MQTT system...');
                
                mqttManager = new MQTTManager();
                
                // Setup message handler for DALI
                mqttManager.onMessage((topic, data) => {
                    handleMQTTMessage(topic, data);
                });
                
                // Setup connection handler
                mqttManager.onConnection((connected, error) => {
                    updateConnectionStatus(connected, error);
                });
                
                console.log('✅ MQTT system initialized');
                return true;
                
            } catch (error) {
                console.error('❌ MQTT initialization failed:', error);
                logToConsole('error', 'MQTT Failed', 'Running in simulation mode: ' + error.message);
                return false;
            }
        }

        async function connectSystems() {
            try {
                console.log('🔌 Connecting to room systems...');
                
                if (mqttManager) {
                    await mqttManager.connect();
                } else {
                    console.log('📋 Running in simulation mode');
                    simulateConnection();
                }
                
                return true;
            } catch (error) {
                console.warn('⚠️ Connection failed:', error);
                updateConnectionStatus(false, error.message);
                return false;
            }
        }

        function simulateConnection() {
            // Removed simulation - only real MQTT connection
            connected = false;
            updateConnectionStatus(false, 'No simulation mode - real connection only');
            logToConsole('error', 'Connection Required', 'Real MQTT connection required for operation');
        }

        // ===== MQTT MESSAGE HANDLING =====
        function handleMQTTMessage(topic, jsonData) {
            try {
                console.log(`📨 Processing message from ${topic}:`, jsonData);
                logToConsole('received', 'MQTT Received', JSON.stringify(jsonData, null, 2));
                
                const messageType = MQTTProtocol.identifyMessageType(jsonData);
                console.log(`🔍 Message type identified: ${messageType}`);
                
                if (messageType === 'DALI_LIGHTS') {
                    handleDALIMessage(jsonData);
                }
                
            } catch (error) {
                console.error('❌ Error processing message:', error);
                logToConsole('error', 'Message Error', error.message);
            }
        }

        function handleDALIMessage(jsonData) {
            try {
                const parsedData = MQTTProtocol.parseDALIMessage(jsonData);
                if (!parsedData) {
                    console.warn('⚠️ Unable to parse DALI message');
                    return;
                }
                
                // Only process Room 02 messages
                if (parsedData.roomNumber !== 2) {
                    console.log(`📍 Ignoring message for Room ${parsedData.roomNumber}`);
                    return;
                }
                
                console.log(`💡 Processing DALI lights for Room ${parsedData.roomNumber} (${parsedData.roomType})`);
                
                // Update DALI controls with received data
                Object.keys(parsedData.zones).forEach(zoneKey => {
                    updateZoneFromMQTT(zoneKey, parsedData.zones[zoneKey]);
                });
                
                lastUpdateTime = new Date().toLocaleString();
                updateInfoModal();
                
            } catch (error) {
                console.error('❌ Error handling DALI message:', error);
                logToConsole('error', 'DALI Error', error.message);
            }
        }

        function updateZoneFromMQTT(zoneKey, zoneData) {
            const zoneMapping = {
                'nTota': 'main',
                'nParz': 'courtesy', 
                'nLett': 'bed',
                'nCoSx': 'leftabat',
                'nCoDx': 'rightabat',
                'nScri': 'desk'
            };
            
            const zoneName = zoneMapping[zoneKey];
            if (zoneName && daliControls[zoneName]) {
                console.log(`🔄 Updating ${zoneName} from MQTT:`, zoneData);
                
                daliControls[zoneName].level = zoneData.currentLevel;
                daliControls[zoneName].isOn = zoneData.isOn;
                updateDALIDisplay(zoneName);
                
                logToConsole('info', `Zone Updated: ${zoneData.label}`, `Level: ${zoneData.currentLevel}% - ${zoneData.isOn ? 'ON' : 'OFF'}`);
            }
        }

        // ===== DALI CONTROL FUNCTIONS =====
        function setDALIControl(zone, action) {
            const isOn = action === 'on';
            daliControls[zone].isOn = isOn;
            
            if (!isOn) {
                daliControls[zone].level = 0;
            } else if (daliControls[zone].level === 0) {
                daliControls[zone].level = 50; // Default level
            }
            
            updateDALIDisplay(zone);
            sendDALICommand(zone);
        }

        function adjustDALILevel(event, zone) {
            const slider = event.currentTarget;
            const rect = slider.getBoundingClientRect();
            const percentage = Math.max(0, Math.min(100, Math.round(((event.clientX - rect.left) / rect.width) * 100)));
            
            daliControls[zone].level = percentage;
            daliControls[zone].isOn = percentage > 0;
            
            updateDALIDisplay(zone);
            sendDALICommand(zone);
        }

        function updateDALIDisplay(zone) {
            const control = daliControls[zone];
            
            // Update level display
            const display = document.getElementById(`${zone}_display`);
            if (display) {
                display.innerHTML = `${control.level}<span class="level-unit">%</span>`;
                display.classList.toggle('on', control.isOn);
                display.classList.toggle('off', !control.isOn);
            }
            
            // Update slider
            const fill = document.getElementById(`${zone}_fill`);
            const thumb = document.getElementById(`${zone}_thumb`);
            if (fill && thumb) {
                fill.style.width = control.level + '%';
                thumb.style.left = `calc(${control.level}% - 12px)`;
                thumb.classList.toggle('active', control.isOn);
            }
            
            // Update buttons
            const onBtn = document.getElementById(`${zone}_on`);
            const offBtn = document.getElementById(`${zone}_off`);
            if (onBtn && offBtn) {
                onBtn.classList.toggle('on-active', control.isOn);
                offBtn.classList.toggle('active', !control.isOn);
            }
            
            // Update status
            const dot = document.getElementById(`${zone}_dot`);
            const status = document.getElementById(`${zone}_status`);
            if (dot && status) {
                dot.classList.toggle('on', control.isOn);
                dot.classList.toggle('off', !control.isOn);
                status.textContent = control.isOn ? 'Lights on' : 'Lights off';
            }
        }

        function sendDALICommand(zone) {
            const control = daliControls[zone];
            
            if (mqttManager && mqttManager.isConnected) {
                const payload = {
                    nCamera: 2,
                    sLocale: 'Camera',
                    sNome: control.mqttName,
                    nLivello: control.level,
                    bOnOff: control.isOn,
                    Timestamp: new Date().toISOString()
                };
                
                const success = mqttManager.publish(payload);
                if (success) {
                    console.log('📤 DALI Command sent:', payload);
                    logToConsole('sent', `${control.mqttName}`, `Level: ${control.level}% - ${control.isOn ? 'ON' : 'OFF'}`);
                }
            } else {
                console.warn('⚠️ MQTT not connected - command not sent');
                logToConsole('error', 'MQTT Required', `Cannot send ${control.mqttName} command - MQTT not connected`);
            }
        }

        // ===== UI FUNCTIONS =====
        function switchTab(tabId, buttonElement = null) {
            // Update navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const targetTab = document.getElementById(`${tabId}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        function updateConnectionStatus(connected, error = null) {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('connectionStatus');
            const mqttStatus = document.getElementById('mqttStatus');
            
            if (indicator && status) {
                if (connected) {
                    indicator.classList.add('connected');
                    indicator.classList.remove('connecting');
                    status.textContent = mqttManager ? 'MQTT Connected' : 'Simulation Mode';
                } else {
                    indicator.classList.remove('connected', 'connecting');
                    status.textContent = 'Disconnected';
                    if (error) {
                        logToConsole('error', 'Connection Error', error);
                    }
                }
            }
            
            if (mqttStatus) {
                mqttStatus.textContent = connected ? 
                    (mqttManager ? 'Connected' : 'Simulation Mode') : 'Disconnected';
            }
            
            updateInfoModal();
        }

        function updateLoadingStatus(message) {
            const details = document.getElementById('loadingDetails');
            if (details) {
                details.textContent = message;
            }
            console.log('⏳', message);
        }

        function updateInfoModal() {
            const elements = {
                infoLastUpdate: lastUpdateTime,
                infoMqttStatus: connected ? 
                    (mqttManager ? 'Connected' : 'Simulation Mode') : 'Disconnected',
                infoClientId: mqttManager ? 
                    mqttManager.config?.clientId || 'Connected' : 'Simulation Mode',
                lastUpdate: lastUpdateTime
            };
            
            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = elements[id];
                }
            });
        }

        // ===== CONSOLE FUNCTIONS =====
        function logToConsole(type, header, data) {
            const content = document.getElementById('consoleContent');
            if (!content) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            
            let icon = '';
            let cssClass = '';
            
            switch(type) {
                case 'sent': 
                    icon = '📤'; 
                    cssClass = 'message-sent';
                    break;
                case 'received': 
                    icon = '📥'; 
                    cssClass = 'message-received';
                    break;
                case 'info': 
                    icon = 'ℹ️'; 
                    cssClass = 'message-info';
                    break;
                case 'error': 
                    icon = '❌'; 
                    cssClass = 'message-error';
                    break;
            }
            
            messageDiv.className = cssClass;
            messageDiv.style.whiteSpace = 'pre-wrap';
            
            let messageText = `[${timestamp}] ${icon} ${header}`;
            if (data) {
                messageText += ':\n' + data;
            }
            
            messageDiv.textContent = messageText;
            content.appendChild(messageDiv);
            content.scrollTop = content.scrollHeight;
            
            // Keep only last 50 messages
            const messages = content.querySelectorAll('div');
            if (messages.length > 50) {
                messages[0].remove();
            }
        }

        function showInfo() {
            const modal = document.getElementById('infoModal');
            if (modal) modal.classList.add('show');
        }

        function hideInfo() {
            const modal = document.getElementById('infoModal');
            if (modal) modal.classList.remove('show');
        }

        function toggleConsole() {
            const panel = document.getElementById('consolePanel');
            if (panel) panel.classList.toggle('show');
        }

        function hideConsole() {
            const panel = document.getElementById('consolePanel');
            if (panel) panel.classList.remove('show');
        }

        // ===== TEST FUNCTIONS =====
        function testAllLights() {
            console.log('🧪 Testing all lights...');
            logToConsole('info', 'Test Started', 'Testing all DALI lights in sequence');
            
            const zones = Object.keys(daliControls);
            let index = 0;
            
            function testNext() {
                if (index >= zones.length) {
                    logToConsole('info', 'Test Complete', 'All lights tested');
                    return;
                }
                
                const zone = zones[index];
                console.log(`🧪 Testing ${zone}...`);
                
                // Turn on at 75%
                daliControls[zone].level = 75;
                daliControls[zone].isOn = true;
                updateDALIDisplay(zone);
                sendDALICommand(zone);
                
                // Turn off after 2 seconds
                setTimeout(() => {
                    daliControls[zone].level = 0;
                    daliControls[zone].isOn = false;
                    updateDALIDisplay(zone);
                    sendDALICommand(zone);
                    
                    index++;
                    setTimeout(testNext, 500);
                }, 2000);
            }
            
            testNext();
        }

        function resetAllLights() {
            console.log('🔄 Resetting all lights...');
            logToConsole('info', 'Reset Started', 'Turning off all DALI lights');
            
            Object.keys(daliControls).forEach(zone => {
                daliControls[zone].level = 0;
                daliControls[zone].isOn = false;
                updateDALIDisplay(zone);
                sendDALICommand(zone);
            });
            
            logToConsole('info', 'Reset Complete', 'All lights turned off');
        }

        // ===== UTILITY FUNCTIONS =====
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Starting AMAN Venice Room 02 Dashboard...');
            
            try {
                await initializeDashboard();
            } catch (error) {
                console.error('❌ Dashboard initialization failed:', error);
            }
        });

        // Enter key support for login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen && loginScreen.style.display !== 'none') {
                    doLogin();
                }
            }
        });

        // Click outside modal to close
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('infoModal');
            if (modal && e.target === modal) {
                hideInfo();
            }
        });

        // Escape key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideInfo();
                hideConsole();
            }
        });

        // ===== DEBUG GLOBALS =====
        window.room02Debug = {
            // MQTT status
            mqttStatus: () => mqttManager?.isConnected || false,
            
            // DALI controls
            daliStatus: () => daliControls,
            
            // Simulate DALI message
            simulateDALI: () => {
                const testMessage = {
                    "Timestamp": new Date().toISOString(),
                    "nCamera": 2,
                    "sNome": "CameraLuci",
                    "nTotaLiv": 75,
                    "nTotaSet": 80,
                    "nParzLiv": 45,
                    "nParzSet": 50,
                    "nCoSxLiv": 20,
                    "nCoSxSet": 25,
                    "nCoDxLiv": 20,
                    "nCoDxSet": 25,
                    "nLettLiv": 60,
                    "nLettSet": 65,
                    "nScriLiv": 90,
                    "nScriSet": 95
                };
                
                console.log('🧪 Simulating DALI message for Room 02');
                handleMQTTMessage('Camere/Plc', testMessage);
            },
            
            // Force reconnect
            reconnect: () => {
                if (mqttManager) {
                    mqttManager.connect();
                } else {
                    console.warn('⚠️ MQTT Manager not initialized');
                }
            },
            
            // System info
            systemInfo: () => ({
                room: '02',
                connected: connected,
                mqttReady: !!mqttManager,
                lastUpdate: lastUpdateTime
            })
        };

        console.log('✅ AMAN Venice Room 02 Dashboard ready');
    </script>
</body>
</html>
                main_on" onclick="setDALIControl('main', 'on')">ON</button>
                                    </div>
                                </div>
                                
                                <div class="level-control">
                                    <div class="level-label">Light Level Setting</div>
                                    <div class="level-slider-container">
                                        <div class="level-slider" onclick="adjustDALILevel(event, 'main')">
                                            <div class="level-fill" id="main_fill" style="width: 0%"></div>
                                            <div class="level-thumb" id="main_thumb" style="left: calc(0% - 12px)"></div>
                                        </div>
                                        <div class="slider-scale">
                                            <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="status-indicator">
                                    <div class="status-dot off" id="main_dot"></div>
                                    <span id="main_status">Lights off</span>
                                </div>
                            </div>
                        </div>

                        <!-- COURTESY LIGHT -->
                        <div class="control-container">
                            <div class="dali-controller" id="dali_courtesy">
                                <div class="group-label uniform-element">🌟 Courtesy Light</div>
                                
                                <div class="main-controls">
                                    <div class="level-display">
                                        <div class="level-value uniform-element off" id="courtesy_display">
                                            0<span class="level-unit">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="power-controls">
                                        <button class="power-btn uniform-element active" id="courtesy_off" onclick="setDALIControl('courtesy', 'off')">OFF</button>
                                        <button class="power-btn uniform-element" id="courtesy_on" onclick="setDALIControl('courtesy', 'on')">ON</button>
                                    </div>
                                </div>
                                
                                <div class="level-control">
                                    <div class="level-label">Light Level Setting</div>
                                    <div class="level-slider-container">
                                        <div class="level-slider" onclick="adjustDALILevel(event, 'courtesy')">
                                            <div class="level-fill" id="courtesy_fill" style="width: 0%"></div>
                                            <div class="level-thumb" id="courtesy_thumb" style="left: calc(0% - 12px)"></div>
                                        </div>
                                        <div class="slider-scale">
                                            <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="status-indicator">
                                    <div class="status-dot off" id="courtesy_dot"></div>
                                    <span id="courtesy_status">Lights off</span>
                                </div>
                            </div>
                        </div>

                        <!-- BED LIGHT -->
                        <div class="control-container">
                            <div class="dali-controller" id="dali_bed">
                                <div class="group-label uniform-element">🛏️ Bed Light</div>
                                
                                <div class="main-controls">
                                    <div class="level-display">
                                        <div class="level-value uniform-element off" id="bed_display">
                                            0<span class="level-unit">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="power-controls">
                                        <button class="power-btn uniform-element active" id="bed_off" onclick="setDALIControl('bed', 'off')">OFF</button>
                                        <button class="power-btn uniform-element" id="bed_on" onclick="setDALIControl('bed', 'on')">ON</button>
                                    </div>
                                </div>
                                
                                <div class="level-control">
                                    <div class="level-label">Light Level Setting</div>
                                    <div class="level-slider-container">
                                        <div class="level-slider" onclick="adjustDALILevel(event, 'bed')">
                                            <div class="level-fill" id="bed_fill" style="width: 0%"></div>
                                            <div class="level-thumb" id="bed_thumb" style="left: calc(0% - 12px)"></div>
                                        </div>
                                        <div class="slider-scale">
                                            <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="status-indicator">
                                    <div class="status-dot off" id="bed_dot"></div>
                                    <span id="bed_status">Lights off</span>
                                </div>
                            </div>
                        </div>

                        <!-- LEFT ABAT JOUR -->
                        <div class="control-container">
                            <div class="dali-controller" id="dali_leftabat">
                                <div class="group-label uniform-element">💡 Left Abat Jour</div>
                                
                                <div class="main-controls">
                                    <div class="level-display">
                                        <div class="level-value uniform-element off" id="leftabat_display">
                                            0<span class="level-unit">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="power-controls">
                                        <button class="power-btn uniform-element active" id="leftabat_off" onclick="setDALIControl('leftabat', 'off')">OFF</button>
                                        <button class="power-btn uniform-element" id="